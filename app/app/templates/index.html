{% extends "base.html" %}
{% block content %}

<div id="header">
    <h1>Ik, Asimov</h1>
</div>

<div class="gen-bar">
<button class="gen-button" id ="1" type="button" onclick="generate()" name="generate">
    <img src="../static/image/plus.png">
</button>
<button class="gen-button" id ="2" type="button" onclick="generate()" name="generate">
    <img src="../static/image/plus.png">
</button>
<button class="gen-button" id ="3" type="button" onclick="generate()" name="generate">
    <img src="../static/image/plus.png">
</button>
<button class="gen-button" id ="4" type="button" onclick="generate()" name="generate">
    <img src="../static/image/plus.png">
</button>
<!-- <input class="temp-slider" onchange="temperature()" type="range" value=0.3 min="0.01" max="1.0" step="0.01" id="temperature" /> -->
</div>

<div id="editor">
    <p><br></p>
</div>

<div id="history">
    <p><br></p>
</div>

<script src="https://cdn.quilljs.com/1.2.6/quill.js"></script>

<script>
    var Delta = Quill.import('delta');
    var quill = new Quill('#editor', {
        scrollingContainer: '#scrolling-container',
        theme: 'snow',
        placeholder: 'Bieb, Bieb!'
    });

    // Store accumulated changes
    var change = new Delta();
    quill.on('text-change', function(delta) {
      change = change.compose(delta);
    });

    // Save periodically
    setInterval(function() {
        if (change.length() > 0) {
            console.log('Saving changes', change);
            // Send partial changes
            $.ajax({
                contentType: 'application/json;charset=UTF-8',
                url: 'savechange',
                data: JSON.stringify(change),//{text: },
                type: 'POST',
                dataType: 'json',
                success: function(response) {
                    console.log(response);
                },
                error: function(error) {
                    console.log(error);
                }
            });
            change = new Delta();
        }
    }, 5*1000);

    setInterval(function() {
        console.log('saving document');
        $.ajax({
            contentType: 'application/json;charset=UTF-8',
            url: 'savedoc',
            data: JSON.stringify(quill.getContents()),
            type: 'POST',
            dataType: 'json',
            success: function(response) {
                console.log(response);
            },
            error: function(error) {
                console.log(error);
            }
        });
    }, 50*1000);

    function generate() {
        var range = quill.getSelection();
        if (range) {
            if (range.length == 0) {
                console.log('User cursor is at index', range.index);
                t = quill.getText(0, range.index)
                var start = range.index;
                for (var i = start; i > -1; i--) {
                    if (t[i] === "." && (start - i) > 10) {
                        start = i;
                        break;
                    }
                    if (i == 0) {
                        start = -2;
                        break;
                    }
                }
                console.log(start, range.index);
                var text = quill.getText(start + 2, range.index)
                console.log(text);
                $.ajax({
                    contentType: 'application/json;charset=UTF-8',
                    url: 'generate',
                    data: JSON.stringify({'selection': text}),
                    type: 'POST',
                    dataType: 'json',
                    success: function(response) {
                        console.log(response);
                        var text = response['message'];
                        if (range.index > 0) {
                            text = " " + text;
                        }
                        quill.insertText(range.index, text, 'underline', true, 'api');
                        quill.format('underline ',false);
                    },
                    error: function(error) {
                        console.log(error);
                    }
                });
            } else {
                var text = quill.getText(range.index, range.length);
                console.log('User has highlighted: ', text);
            }
        } else {
            console.log('User cursor is not in editor');
        }
        history(text)
    };

    function temperature() {
        var temp = document.getElementById('temperature').value;
        $.ajax({
            contentType: 'application/json;charset=UTF-8',
            url: 'temperature',
            data: JSON.stringify({data: temp}),
            type: 'POST',
            dataType: 'json',
            success: function(response) {
                console.log(response);
            },
            error: function(error) {
                console.log(error);
            }
        });
    };

    function history(text) {
        // add the text to a history stack, that gets printed on the side.
        document.getElementById("history").innerHTML += ('<div class="history-item"><p>'+text[0]+'</p><ul><li><a onclick="quill.insertText(0, text)">'+text[1]+'</a></li><li><a onclick="quill.insertText(0, text)">'+text[2]+'</a></li><li><a onclick="quill.insertText(0, text)">'+text[3]+'</a></li><li><a onclick="quill.insertText(0, text)">'+text[4]+'</a></li><li><a onclick="quill.insertText(0, text)">'+text[5]+'</a></li></ul></div>');
    }

    window.onbeforeunload = function() {
      if (change.length() > 0) {
        return 'There are unsaved changes. Are you sure you want to leave?';
      }
    }
</script>

{% endblock %}
